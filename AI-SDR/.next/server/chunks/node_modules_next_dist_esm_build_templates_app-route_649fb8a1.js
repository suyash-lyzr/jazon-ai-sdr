module.exports=[87488,e=>{"use strict";e.s(["handler",()=>G,"patchFetch",()=>K,"routeModule",()=>q,"serverHooks",()=>F,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>J],87488);var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),s=e.i(61916),o=e.i(69741),i=e.i(16795),d=e.i(87718),l=e.i(95169),c=e.i(47587),u=e.i(66012),p=e.i(70101),g=e.i(26937),_=e.i(10372),f=e.i(93695);e.i(52474);var h=e.i(220);e.s(["POST",()=>U,"maxDuration",()=>I,"runtime",()=>b],74986);var y=e.i(89171),m=e.i(49991),w=e.i(97928),R=e.i(56385),O=e.i(83079),S=e.i(90410),v=e.i(19938),E=e.i(33053),C=e.i(42889),A=e.i(29150),x=e.i(22734),N=e.i(14747);let b="nodejs",I=300,$="https://agent-prod.studio.lyzr.ai/v3/inference/chat/",T=process.env.LYZR_API_KEY||"sk-default-eE6EHcdIhXl61H4mK4YKZFqISTGrruf1",j=process.env.OUTREACH_STRATEGY_AGENT_ID||"69453743f6d93e181164e4d0",P=process.env.OUTREACH_COPY_AGENT_ID||"6948162d2be72f04a7d64f65",D=process.env.LYZR_USER_ID||"suyash@lyzr.ai";function k(e,t){if(e&&"object"==typeof e)return e;if("string"!=typeof e)throw Error(`${t}: expected string or object response, got ${typeof e}`);let a=e.trim(),r=a.replace(/^```(?:json)?\s*\n?/i,"").replace(/\n?```\s*$/i,"").trim();if(!(r.startsWith("{")||r.startsWith("["))){let e=a.match(/```(?:json)?\s*([\s\S]*?)```/i);e?.[1]&&(r=e[1].trim())}if(!(r.startsWith("{")||r.startsWith("[")))throw Error(`${t}: could not locate JSON in agent response`);let n=(e=>{let t="",a=!1,r=!1;for(let n=0;n<e.length;n++){let s=e[n];if(r){t+=s,r=!1;continue}if("\\"===s){t+=s,r=!0;continue}if('"'===s){a=!a,t+=s;continue}if(a&&"\n"===s){t+="\\n";continue}if(a&&"\r"===s){t+="\\r";continue}t+=s}return t})(r);try{return JSON.parse(n)}catch(e){return JSON.parse((e=>{let t="",a=[],r=!1,n=!1,s=e=>{"{"===e?a.push("}"):"["===e&&a.push("]")},o=e=>"{"===e||"["===e,i=e=>"}"===e||"]"===e;for(let d=0;d<e.length;d++){let l=e[d];if(n){t+=l,n=!1;continue}if("\\"===l){t+=l,n=!0;continue}if('"'===l){r=!r,t+=l;continue}if(r){t+=l;continue}if(o(l)){s(l),t+=l;continue}if(i(l)){if(a.length>0&&a[a.length-1]!==l){t+=a.pop();continue}a.length>0&&a[a.length-1]===l&&a.pop(),t+=l;continue}t+=l}for(;a.length>0;)t+=a.pop();return t})(n))}}async function U(e,{params:t}){try{let e,a;await (0,m.default)();let{id:r}=await t;console.log(`âœ… Database connected for POST /api/leads/${r}/outreach/generate`);let n=await w.default.findById(r).populate("company_id").populate("persona_id");if(!n)return y.NextResponse.json({success:!1,error:"Lead not found"},{status:404});let s=await R.default.findOne({lead_id:r}),o=await O.default.findOne({lead_id:r});if(!s||!o)return y.NextResponse.json({success:!1,error:"Research and ICP scoring must be completed before generating outreach"},{status:400});console.log(`ðŸ“‹ Generating outreach for lead: ${n.name} (ICP: ${o.icp_score})`),console.log("ðŸŽ¯ Calling Outreach Strategy Agent...");let i=await A.default.find({lead_id:r}),d={lead:{name:n.name,title:n.title,email:n.email},company:n.company_id.toObject(),persona:n.persona_id.toObject(),research:s.research_meta,icp_score:{icp_score:o.icp_score,fit_tier:o.fit_tier,score_breakdown:o.score_breakdown,strengths:o.strengths,risks:o.risks},detected_signals:i.map(e=>e.toObject())},l=`strategy-${r}-${Date.now()}`,c=await fetch($,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":T},body:JSON.stringify({user_id:D,agent_id:j,session_id:l,message:JSON.stringify(d)})});if(!c.ok){let e=await c.text();throw Error(`Strategy Agent API error: ${c.status} - ${e}`)}let u=await c.json();try{e=k(u.response,"Strategy agent")}catch(t){console.warn("âš ï¸ Could not parse strategy response as JSON, using raw response",t),e={strategy_status:"ERROR",blocking_reason:"Failed to parse agent response",raw_response:u.response}}let p=N.default.join(process.cwd(),"output");x.default.existsSync(p)||x.default.mkdirSync(p,{recursive:!0});let g=new Date().toISOString().replace(/[:.]/g,"-"),_=`outreach-strategy-agent-response-${r}-${g}.json`,f=N.default.join(p,_);if(x.default.writeFileSync(f,JSON.stringify({leadId:r,leadName:n.name,leadCompany:n.company_id?.name||"Unknown",timestamp:new Date().toISOString(),agentResponse:u,parsedStrategyData:e,strategyInput:d},null,2),"utf-8"),console.log(`ðŸ’¾ Strategy response saved to: ${f}`),console.log("ðŸ“Š Parsed Strategy Output:",JSON.stringify(e,null,2)),!e||"object"!=typeof e)throw Error("Strategy output is not an object after parsing; refusing to persist invalid strategy_output");let h=await v.default.create({lead_id:r,research_run_id:s._id,icp_score_id:o._id,strategy_output:{...e,strategy_meta:{...e.strategy_meta,inputs_used:{research_run_id:s._id.toString(),icp_score_id:o._id.toString()}}}});if(console.log(`âœ… Outreach Strategy saved (status: ${e.strategy_status})`),"NO_OUTREACH"===e.strategy_status)return await S.default.findOneAndUpdate({lead_id:r},{status:"disqualified",final_decision:{status:"No outreach",reason:e.reason||"Strategy determined no outreach"}},{upsert:!0}),y.NextResponse.json({success:!0,message:"Strategy generated but no outreach recommended",strategy_status:"NO_OUTREACH",reason:e.reason},{status:200});console.log("âœï¸ Calling Outreach Copy Agent...");let b={lead:{name:n.name,title:n.title,email:n.email},company:n.company_id.toObject(),persona:n.persona_id.toObject(),research:s.research_meta,icp_score:{icp_score:o.icp_score,fit_tier:o.fit_tier},strategy:e,strategy_run_id:h._id.toString()},I=`copy-${r}-${Date.now()}`,U=await fetch($,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":T},body:JSON.stringify({user_id:D,agent_id:P,session_id:I,message:JSON.stringify(b)})});if(!U.ok){let e=await U.text();throw Error(`Copy Agent API error: ${U.status} - ${e}`)}let H=await U.json();try{a=k(H.response,"Copy agent")}catch(e){console.warn("âš ï¸ Could not parse copy response as JSON, using raw response",e),a={status:"ERROR",drafts:[],raw_response:H.response}}let q=new Date().toISOString().replace(/[:.]/g,"-"),M=`outreach-copy-agent-response-${r}-${q}.json`,J=N.default.join(p,M);if(x.default.writeFileSync(J,JSON.stringify({leadId:r,leadName:n.name,leadCompany:n.company_id?.name||"Unknown",timestamp:new Date().toISOString(),agentResponse:H,parsedCopyData:a,copyInput:b,strategyRunId:h._id.toString()},null,2),"utf-8"),console.log(`ðŸ’¾ Copy response saved to: ${J}`),console.log("ðŸ“Š Parsed Copy Output:",JSON.stringify(a,null,2)),!a||"object"!=typeof a)throw Error("Copy output is not an object after parsing; refusing to persist invalid copy_output");let F=await E.default.create({lead_id:r,strategy_run_id:h._id,copy_output:{...a,copy_meta:{...a.copy_meta,strategy_run_id:h._id.toString()}}});console.log(`âœ… Outreach Copy saved (status: ${a.status})`);let K=e.recommended_channel_sequence?.length||0,G=e.recommended_channel_sequence?.[0];await S.default.findOneAndUpdate({lead_id:r},{status:"active",current_phase:"Engagement",current_step_number:1,next_planned_action:{label:G?.goal||"Start outreach",scheduled_at:G?.recommended_delay_hours?new Date(Date.now()+36e5*G.recommended_delay_hours):null},final_decision:{status:"In progress",reason:"Outreach strategy generated and ready"}},{upsert:!0,new:!0});let L=await S.default.findOne({lead_id:r}),B=await C.default.findOne({lead_id:r}).sort({sort_order:-1}),W=(B?.sort_order||0)+1;return await C.default.create({lead_id:r,campaign_id:L._id,event_type:"decision",actor:"AI",timestamp:new Date,sort_order:W++,title:"Outreach strategy generated",summary:`AI-generated ${K}-step outreach strategy with channels: ${e.recommended_channel_sequence?.map(e=>e.channel).join(", ")}. Strategy confidence: ${e.confidence_level}.`,badge:"AI Decision",metadata:{strategy_run_id:h._id,total_steps:K,channels:e.recommended_channel_sequence?.map(e=>e.channel),confidence:e.confidence_level}}),await C.default.create({lead_id:r,campaign_id:L._id,event_type:"outreach",actor:"AI",timestamp:new Date,sort_order:W++,title:"Outreach copy generated",summary:`AI-generated personalized copy for ${a.drafts?.length||0} outreach steps. Copy confidence: ${a.confidence_level}.`,badge:"Outreach Prepared",metadata:{copy_run_id:F._id,drafts_count:a.drafts?.length||0,confidence:a.confidence_level}}),await C.default.create({lead_id:r,campaign_id:L._id,event_type:"lifecycle",actor:"System",timestamp:new Date,sort_order:W++,title:"Outreach campaign ready",summary:`Campaign configured and ready to execute. Next step: ${G?.goal||"Begin outreach"}`,badge:"Campaign Ready",metadata:{next_step:G?.goal,scheduled_at:L.next_planned_action.scheduled_at}}),console.log(`âœ… Outreach campaign generated for lead ${r}`),y.NextResponse.json({success:!0,message:"Outreach strategy and copy generated successfully",data:{strategy_status:e.strategy_status,copy_status:a.status,total_steps:K,campaign_status:"active"}},{status:200})}catch(e){return console.error("âŒ API Error:",e),y.NextResponse.json({success:!1,error:"Internal server error",message:e.message||"An unexpected error occurred"},{status:500})}}var H=e.i(74986);let q=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/leads/[id]/outreach/generate/route",pathname:"/api/leads/[id]/outreach/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/leads/[id]/outreach/generate/route.ts",nextConfigOutput:"",userland:H}),{workAsyncStorage:M,workUnitAsyncStorage:J,serverHooks:F}=q;function K(){return(0,r.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:J})}async function G(e,t,r){var y;let m="/api/leads/[id]/outreach/generate/route";m=m.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:O,nextConfig:S,isDraftMode:v,prerenderManifest:E,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:x,resolvedPathname:N}=w,b=(0,o.normalizeAppPath)(m),I=!!(E.dynamicRoutes[b]||E.routes[N]);if(I&&!v){let e=!!E.routes[N],t=E.dynamicRoutes[b];if(t&&!1===t.fallback&&!e)throw new f.NoFallbackError}let $=null;!I||q.isDev||v||($="/index"===($=N)?"/":$);let T=!0===q.isDev||!I,j=I&&!T,P=e.method||"GET",D=(0,s.getTracer)(),k=D.getActiveScopeSpan(),U={params:O,prerenderManifest:E,renderOpts:{experimental:{cacheComponents:!!S.experimental.cacheComponents,authInterrupts:!!S.experimental.authInterrupts},supportsDynamicResponse:T,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(y=S.experimental)?void 0:y.cacheLife,isRevalidate:j,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>q.onRequestError(e,t,r,C)},sharedContext:{buildId:R}},H=new i.NodeNextRequest(e),M=new i.NodeNextResponse(t),J=d.NextRequestAdapter.fromNodeNextRequest(H,(0,d.signalFromNodeResponse)(t));try{let o=async a=>q.handle(J,U).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let e=`${P} ${n}`;a.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),a.updateName(e)}else a.updateName(`${P} ${e.url}`)}),i=async s=>{var i,d;let l=async({previousCacheEntry:a})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&A&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(s);e.fetchMetrics=U.renderOpts.fetchMetrics;let d=U.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let l=U.renderOpts.collectedTags;if(!I)return await (0,u.sendResponse)(H,M,i,U.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[_.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==U.renderOpts.collectedRevalidate&&!(U.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&U.renderOpts.collectedRevalidate,r=void 0===U.renderOpts.collectedExpire||U.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:U.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:j,isOnDemandRevalidate:A})},C),t}},f=await q.handleResponse({req:e,nextConfig:S,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:x,responseGenerator:l,waitUntil:r.waitUntil});if(!I)return null;if((null==f||null==(i=f.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==f||null==(d=f.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",A?"REVALIDATED":f.isMiss?"MISS":f.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(f.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&I||y.delete(_.NEXT_CACHE_TAGS_HEADER),!f.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,g.getCacheControlHeader)(f.cacheControl)),await (0,u.sendResponse)(H,M,new Response(f.value.body,{headers:y,status:f.value.status||200})),null};k?await i(k):await D.withPropagatedContext(e.headers,()=>D.trace(l.BaseServerSpan.handleRequest,{spanName:`${P} ${e.url}`,kind:s.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},i))}catch(t){if(k||t instanceof f.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:j,isOnDemandRevalidate:A})}),I)throw t;return await (0,u.sendResponse)(H,M,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_649fb8a1.js.map