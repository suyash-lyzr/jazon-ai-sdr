module.exports=[2e3,e=>{"use strict";e.s(["handler",()=>K,"patchFetch",()=>J,"routeModule",()=>U,"serverHooks",()=>q,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>H],2e3);var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),o=e.i(61916),i=e.i(69741),s=e.i(16795),l=e.i(87718),d=e.i(95169),c=e.i(47587),u=e.i(66012),p=e.i(70101),f=e.i(26937),g=e.i(10372),h=e.i(93695);e.i(52474);var m=e.i(220);e.s(["POST",()=>j,"runtime",()=>x],37331);var _=e.i(89171),y=e.i(49991),w=e.i(97928),R=e.i(588),S=e.i(24291),C=e.i(23885),v=e.i(56385),$=e.i(41048),P=e.i(29150),E=e.i(83079),A=e.i(74136),N=e.i(22734),I=e.i(14747);let x="nodejs",O="https://agent-prod.studio.lyzr.ai/v3/inference/chat/",b="sk-default-eE6EHcdIhXl61H4mK4YKZFqISTGrruf1",k="69451f56d9c1eef9bdbd3957",T="6945269078787390cded7e01",D="suyash@lyzr.ai";async function j(e){try{let t;await (0,y.default)(),console.log("âœ… Database connected for lead refresh");let a=(await e.json().catch(()=>({}))).leadId||null;if(a?(t=await w.default.find({_id:a}).populate("company_id").populate("persona_id"),console.log(`ðŸ“‹ Fetching specific lead: ${a}`)):(t=await w.default.find({status:"uploaded"}).populate("company_id").populate("persona_id"),console.log(`ðŸ“‹ Found ${t.length} leads with status "uploaded"`)),!t||0===t.length)return _.NextResponse.json({success:!0,message:"No leads found to refresh",processed:0,responses:[]},{status:200});let r=[],n=[];for(let e of t)try{let t,a,n=e.company_id,o=e.persona_id,i={name:e.name,title:e.title,company:n.name,email:e.email||""},s=`${k}-${e._id.toString()}-${Date.now()}`,l=`Please perform research and enrichment for the following lead:

Name: ${i.name}, 
Title: ${i.title}, 
Company: ${i.company}, 
Email: ${i.email||"Not provided"}
`;console.log(`
ðŸ” Processing lead: ${i.name} (${i.company})`),console.log(`ðŸ“¤ Sending to Research Agent...`);let d=await fetch(O,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":b},body:JSON.stringify({user_id:D,agent_id:k,session_id:s,message:l})});if(!d.ok){let e=await d.text();throw Error(`Agent API error: ${d.status} - ${e}`)}let c=await d.json();console.log(`âœ… Research Agent response received for ${i.name}`);try{t="string"==typeof c.response?JSON.parse(c.response):c.response}catch(e){console.warn("âš ï¸ Could not parse research response as JSON, using raw response"),t=c.response}let u=I.default.join(process.cwd(),"output");N.default.existsSync(u)||N.default.mkdirSync(u,{recursive:!0});let p=new Date().toISOString().replace(/[:.]/g,"-"),f=`research-agent-response-${e._id.toString()}-${p}.json`,g=I.default.join(u,f);if(N.default.writeFileSync(g,JSON.stringify({leadId:e._id.toString(),leadName:i.name,leadCompany:i.company,timestamp:new Date().toISOString(),agentResponse:c,parsedResearchData:t},null,2),"utf-8"),console.log(`ðŸ’¾ Research response saved to: ${g}`),t.CompanyProfile){let e=t.CompanyProfile;await R.default.findByIdAndUpdate(n._id,{domain:e.domain||n.domain,website_url:e.website_url||n.website_url,linkedin_url:e.linkedin_url||n.linkedin_url,industry:e.industry||n.industry,company_size:e.company_size||n.company_size,headquarters:e.headquarters||n.headquarters,structure:e.structure||n.structure,sales_motion:e.sales_motion||n.sales_motion,keywords:e.keywords||n.keywords,confidence:e.confidence||n.confidence}),console.log(`âœ… Company ${n._id} updated`)}if(t.PersonaProfile){let e=t.PersonaProfile;await S.default.findByIdAndUpdate(o._id,{full_name:e.full_name||o.full_name,email:e.email||o.email,linkedin_url:e.linkedin_url||o.linkedin_url,title:e.title||o.title,seniority:e.seniority||o.seniority,department:e.department||o.department,location:e.location||o.location,reports_to:e.reports_to||o.reports_to,decision_authority:e.decision_authority||o.decision_authority,responsibilities:e.responsibilities||o.responsibilities,pain_points:e.pain_points||o.pain_points,confidence:e.confidence||o.confidence}),console.log(`âœ… Persona ${o._id} updated`)}if(t.CompanyProfile&&t.CompanyProfile.technographics){for(let e of(await C.default.deleteMany({company_id:n._id}),t.CompanyProfile.technographics))await C.default.create({company_id:n._id,name:e.name,category:e.category,confidence:e.confidence,source:e.source});console.log(`âœ… Created ${t.CompanyProfile.technographics.length} technographics`)}let h=await v.default.findOneAndUpdate({lead_id:e._id},{lead_id:e._id,company_id:n._id,persona_id:o._id,research_meta:t.ResearchMeta||{}},{upsert:!0,new:!0});if(console.log(`âœ… ResearchRun ${h._id} created/updated`),t.ResearchMeta&&t.ResearchMeta.citations){for(let e of(await $.default.deleteMany({research_run_id:h._id}),t.ResearchMeta.citations))await $.default.create({research_run_id:h._id,source_name:e.source_name,url:e.url,accessed_at_utc:e.accessed_at_utc});console.log(`âœ… Created ${t.ResearchMeta.citations.length} citations`)}if(t.DetectedSignals){for(let a of(await P.default.deleteMany({lead_id:e._id}),t.DetectedSignals))await P.default.create({lead_id:e._id,research_run_id:h._id,type:a.type,signal:a.signal,source:a.source,strength:a.strength,recency:a.recency,evidence:a.evidence});console.log(`âœ… Created ${t.DetectedSignals.length} detected signals`)}await w.default.findByIdAndUpdate(e._id,{status:"researched"}),console.log(`
ðŸ“Š Calling ICP Scoring Agent for ${i.name}...`);let m=`${T}-${e._id.toString()}-${Date.now()}`,_=`Please perform ICP scoring for the following lead based on the research data:

Lead Information:
- Name: ${i.name}
- Title: ${i.title}
- Company: ${i.company}
- Email: ${i.email||"Not provided"}

Research Data:
${JSON.stringify(t,null,2)}`,y=await fetch(O,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":b},body:JSON.stringify({user_id:D,agent_id:T,session_id:m,message:_})});if(!y.ok){let e=await y.text();throw Error(`ICP Agent API error: ${y.status} - ${e}`)}let x=await y.json();console.log(`âœ… ICP Agent response received for ${i.name}`);try{a="string"==typeof x.response?JSON.parse(x.response):x.response}catch(e){console.warn("âš ï¸ Could not parse ICP response as JSON, using raw response"),a=x.response}let j=`icp-agent-response-${e._id.toString()}-${p}.json`,M=I.default.join(u,j);N.default.writeFileSync(M,JSON.stringify({leadId:e._id.toString(),leadName:i.name,timestamp:new Date().toISOString(),agentResponse:x,parsedIcpData:a},null,2),"utf-8"),console.log(`ðŸ’¾ ICP response saved to: ${M}`);let U=await E.default.findOneAndUpdate({lead_id:e._id},{lead_id:e._id,icp_score:a.icp_score,fit_tier:a.fit_tier,score_breakdown:a.score_breakdown,strengths:a.strengths,risks:a.risks,gaps:a.gaps,confidence_level:a.confidence_level,scoring_meta:a.scoring_meta},{upsert:!0,new:!0});if(console.log(`âœ… ICPScore ${U._id} created/updated`),a.factor_breakdown){for(let e of(await A.default.deleteMany({icp_score_id:U._id}),["companyFit","personaFit","timingFit"]))a.factor_breakdown[e]&&await A.default.create({icp_score_id:U._id,category:e,score:a.factor_breakdown[e].score,factors:a.factor_breakdown[e].factors});console.log(`âœ… Created ICP factor breakdowns`)}await w.default.findByIdAndUpdate(e._id,{status:"icp_scored"}),console.log(`âœ… Lead ${e._id} processing complete with normalized data`),r.push({leadId:e._id.toString(),leadName:i.name,leadCompany:i.company,researchFile:g,icpFile:M})}catch(t){console.error(`âŒ Error processing lead ${e._id}:`,t),n.push({leadId:e._id.toString(),leadName:e.name,error:t.message||"Unknown error"})}let o=new Date().toISOString().replace(/[:.]/g,"-"),i=`refresh-summary-${o}.json`,s=I.default.join(process.cwd(),"output"),l=I.default.join(s,i);return N.default.writeFileSync(l,JSON.stringify({timestamp:new Date().toISOString(),summary:{totalProcessed:r.length,totalFailed:n.length,totalLeads:r.length+n.length},responses:r,errors:n},null,2),"utf-8"),console.log(`
ðŸ“Š Refresh Summary:`),console.log(`  âœ… Successfully processed: ${r.length} leads`),console.log(`  âŒ Errors: ${n.length} leads`),console.log(`  ðŸ’¾ Summary saved to: ${l}`),_.NextResponse.json({success:!0,message:`Processed ${r.length} lead(s) with normalized schema`,processed:r.length,failed:n.length,responses:r,errors:n.length>0?n:void 0,summaryFile:l},{status:200})}catch(e){return console.error("âŒ API Error:",e),_.NextResponse.json({success:!1,error:"Internal server error",message:e.message||"An unexpected error occurred",details:e.toString()},{status:500})}}var M=e.i(37331);let U=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/leads/refresh/route",pathname:"/api/leads/refresh",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/leads/refresh/route.ts",nextConfigOutput:"",userland:M}),{workAsyncStorage:F,workUnitAsyncStorage:H,serverHooks:q}=U;function J(){return(0,r.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:H})}async function K(e,t,r){var _;let y="/api/leads/refresh/route";y=y.replace(/\/index$/,"")||"/";let w=await U.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:S,nextConfig:C,isDraftMode:v,prerenderManifest:$,routerServerContext:P,isOnDemandRevalidate:E,revalidateOnlyGenerated:A,resolvedPathname:N}=w,I=(0,i.normalizeAppPath)(y),x=!!($.dynamicRoutes[I]||$.routes[N]);if(x&&!v){let e=!!$.routes[N],t=$.dynamicRoutes[I];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let O=null;!x||U.isDev||v||(O="/index"===(O=N)?"/":O);let b=!0===U.isDev||!x,k=x&&!b,T=e.method||"GET",D=(0,o.getTracer)(),j=D.getActiveScopeSpan(),M={params:S,prerenderManifest:$,renderOpts:{experimental:{cacheComponents:!!C.experimental.cacheComponents,authInterrupts:!!C.experimental.authInterrupts},supportsDynamicResponse:b,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(_=C.experimental)?void 0:_.cacheLife,isRevalidate:k,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>U.onRequestError(e,t,r,P)},sharedContext:{buildId:R}},F=new s.NodeNextRequest(e),H=new s.NodeNextResponse(t),q=l.NextRequestAdapter.fromNodeNextRequest(F,(0,l.signalFromNodeResponse)(t));try{let i=async a=>U.handle(q,M).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let e=`${T} ${n}`;a.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),a.updateName(e)}else a.updateName(`${T} ${e.url}`)}),s=async o=>{var s,l;let d=async({previousCacheEntry:a})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&E&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=M.renderOpts.collectedTags;if(!x)return await (0,u.sendResponse)(F,H,s,M.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,r=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:k,isOnDemandRevalidate:E})},P),t}},h=await U.handleResponse({req:e,nextConfig:C,cacheKey:O,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:A,responseGenerator:d,waitUntil:r.waitUntil});if(!x)return null;if((null==h||null==(s=h.value)?void 0:s.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",E?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,p.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&x||_.delete(g.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,f.getCacheControlHeader)(h.cacheControl)),await (0,u.sendResponse)(F,H,new Response(h.value.body,{headers:_,status:h.value.status||200})),null};j?await s(j):await D.withPropagatedContext(e.headers,()=>D.trace(d.BaseServerSpan.handleRequest,{spanName:`${T} ${e.url}`,kind:o.SpanKind.SERVER,attributes:{"http.method":T,"http.target":e.url}},s))}catch(t){if(j||t instanceof h.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:k,isOnDemandRevalidate:E})}),x)throw t;return await (0,u.sendResponse)(F,H,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_6bca7ecf.js.map