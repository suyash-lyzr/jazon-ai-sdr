module.exports=[16867,e=>{"use strict";e.s(["handler",()=>B,"patchFetch",()=>F,"routeModule",()=>H,"serverHooks",()=>j,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>U],16867);var t=e.i(47909),a=e.i(74017),n=e.i(96250),o=e.i(59756),d=e.i(61916),i=e.i(69741),l=e.i(16795),r=e.i(87718),s=e.i(95169),u=e.i(47587),c=e.i(66012),p=e.i(70101),_=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var g=e.i(220);e.s(["DELETE",()=>M,"GET",()=>I,"runtime",()=>T],82275);var y=e.i(89171),m=e.i(49991),w=e.i(97928),R=e.i(588),C=e.i(24291),v=e.i(23885),E=e.i(56385),A=e.i(41048),x=e.i(29150),D=e.i(83079),$=e.i(74136),b=e.i(90410),N=e.i(19938),O=e.i(33053),k=e.i(42889),P=e.i(92415);let T="nodejs";async function I(e,{params:t}){try{await (0,m.default)();let{id:e}=await t;console.log(`âœ… Database connected for GET /api/leads/${e}`);let a=await w.default.findById(e).populate("company_id").populate("persona_id");if(!a)return y.NextResponse.json({success:!1,error:"Lead not found"},{status:404});let n=a.company_id,o=a.persona_id,d=await v.default.find({company_id:n._id}),i=await E.default.findOne({lead_id:a._id}),l=[];i&&(l=await A.default.find({research_run_id:i._id}));let r=await x.default.find({lead_id:a._id}),s=await D.default.findOne({lead_id:a._id}),u=null;if(s){let e=await $.default.find({icp_score_id:s._id});u={companyFit:e.find(e=>"companyFit"===e.category),personaFit:e.find(e=>"personaFit"===e.category),timingFit:e.find(e=>"timingFit"===e.category)}}let c={_id:a._id,name:a.name,title:a.title,email:a.email,status:a.status,source:a.source,source_metadata:a.source_metadata,company:{_id:n._id,name:n.name,domain:n.domain,website_url:n.website_url,linkedin_url:n.linkedin_url,industry:n.industry,company_size:n.company_size,headquarters:n.headquarters,structure:n.structure,sales_motion:n.sales_motion,keywords:n.keywords,confidence:n.confidence,technographics:d},persona:{_id:o._id,full_name:o.full_name,email:o.email,linkedin_url:o.linkedin_url,title:o.title,seniority:o.seniority,department:o.department,location:o.location,reports_to:o.reports_to,decision_authority:o.decision_authority,responsibilities:o.responsibilities,pain_points:o.pain_points,confidence:o.confidence},research_run:i?{_id:i._id,research_meta:i.research_meta,citations:l,createdAt:i.createdAt,updatedAt:i.updatedAt}:null,detected_signals:r,icp_score:s?{_id:s._id,icp_score:s.icp_score,fit_tier:s.fit_tier,score_breakdown:s.score_breakdown,strengths:s.strengths,risks:s.risks,gaps:s.gaps,confidence_level:s.confidence_level,scoring_meta:s.scoring_meta,factor_breakdown:u,createdAt:s.createdAt,updatedAt:s.updatedAt}:null,createdAt:a.createdAt,updatedAt:a.updatedAt};return console.log(`âœ… Retrieved lead ${e} with full normalized data`),y.NextResponse.json({success:!0,lead:c},{status:200})}catch(e){return console.error("âŒ API Error:",e),y.NextResponse.json({success:!1,error:"Internal server error",message:e.message||"An unexpected error occurred"},{status:500})}}async function M(t,{params:a}){try{await (0,m.default)();let{id:t}=await a;console.log(`âœ… Database connected for DELETE /api/leads/${t}`);let n=await w.default.findById(t);if(!n)return y.NextResponse.json({success:!1,error:"Lead not found"},{status:404});console.log(`ðŸ—‘ï¸ Deleting lead: ${n.name} (${t})`);let o=await D.default.findOne({lead_id:t});if(o){let e=await $.default.deleteMany({icp_score_id:o._id});console.log(`  âœ“ Deleted ${e.deletedCount} ICP factor breakdowns`)}let d=await D.default.deleteOne({lead_id:t});console.log(`  âœ“ Deleted ${d.deletedCount} ICP score`);let i=await E.default.findOne({lead_id:t});if(i){let e=await A.default.deleteMany({research_run_id:i._id});console.log(`  âœ“ Deleted ${e.deletedCount} citations`)}let l=await x.default.deleteMany({lead_id:t});console.log(`  âœ“ Deleted ${l.deletedCount} detected signals`);let r=await E.default.deleteOne({lead_id:t});console.log(`  âœ“ Deleted ${r.deletedCount} research run`),console.log(`  ðŸ—‘ï¸ Deleting outreach data for lead ${t}...`);let s=await b.default.findOne({lead_id:t}),u=s?._id,c=await N.default.find({lead_id:t}),p=await O.default.find({lead_id:t});if(u){let e=await P.default.deleteMany({entity_type:"outreach_campaign",entity_id:u});console.log(`  âœ“ Deleted ${e.deletedCount} campaign field overrides`)}for(let e of c){let t=await P.default.deleteMany({entity_type:"outreach_strategy",entity_id:e._id});t.deletedCount>0&&console.log(`  âœ“ Deleted ${t.deletedCount} strategy field overrides`)}for(let e of p){let t=await P.default.deleteMany({entity_type:"outreach_copy",entity_id:e._id});t.deletedCount>0&&console.log(`  âœ“ Deleted ${t.deletedCount} copy field overrides`)}let _=await k.default.deleteMany({lead_id:t});console.log(`  âœ“ Deleted ${_.deletedCount} outreach events`);let f=await O.default.deleteMany({lead_id:t});console.log(`  âœ“ Deleted ${f.deletedCount} outreach copy runs`);let h=await N.default.deleteMany({lead_id:t});console.log(`  âœ“ Deleted ${h.deletedCount} outreach strategy runs`);let g=await b.default.deleteOne({lead_id:t});console.log(`  âœ“ Deleted ${g.deletedCount} outreach campaign`);try{let a=(await e.A(79525)).default,n=await a.deleteMany({lead_id:t});n.deletedCount>0&&console.log(`  âœ“ Deleted ${n.deletedCount} outreach guardrails`)}catch(e){console.log(`  âš ï¸ Skipped guardrails deletion (may be global)`)}let T=n.company_id,I=n.persona_id,M=await w.default.countDocuments({company_id:T,_id:{$ne:t}}),S=await w.default.countDocuments({persona_id:I,_id:{$ne:t}});if(await w.default.findByIdAndDelete(t),console.log(`  âœ“ Deleted lead`),0===M){let e=await v.default.deleteMany({company_id:T});console.log(`  âœ“ Deleted ${e.deletedCount} technographics`),await R.default.findByIdAndDelete(T),console.log(`  âœ“ Deleted company (no other leads using it)`)}else console.log(`  âš ï¸ Company not deleted (${M} other lead(s) using it)`);return 0===S?(await C.default.findByIdAndDelete(I),console.log(`  âœ“ Deleted persona (no other leads using it)`)):console.log(`  âš ï¸ Persona not deleted (${S} other lead(s) using it)`),console.log(`âœ… Successfully deleted lead ${t} and all related data`),y.NextResponse.json({success:!0,message:"Lead and all related data deleted successfully",deleted:{lead:!0,icp_score:d.deletedCount>0,factor_breakdowns:!!o,research_run:r.deletedCount>0,citations:!!i,detected_signals:l.deletedCount>0,outreach_campaign:g.deletedCount>0,outreach_strategy_runs:h.deletedCount,outreach_copy_runs:f.deletedCount,outreach_events:_.deletedCount,field_overrides:!0,company:0===M,persona:0===S,technographics:0===M}},{status:200})}catch(e){return console.error("âŒ API Error:",e),y.NextResponse.json({success:!1,error:"Internal server error",message:e.message||"An unexpected error occurred"},{status:500})}}var S=e.i(82275);let H=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/leads/[id]/route",pathname:"/api/leads/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/leads/[id]/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:q,workUnitAsyncStorage:U,serverHooks:j}=H;function F(){return(0,n.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:U})}async function B(e,t,n){var y;let m="/api/leads/[id]/route";m=m.replace(/\/index$/,"")||"/";let w=await H.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:C,nextConfig:v,isDraftMode:E,prerenderManifest:A,routerServerContext:x,isOnDemandRevalidate:D,revalidateOnlyGenerated:$,resolvedPathname:b}=w,N=(0,i.normalizeAppPath)(m),O=!!(A.dynamicRoutes[N]||A.routes[b]);if(O&&!E){let e=!!A.routes[b],t=A.dynamicRoutes[N];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let k=null;!O||H.isDev||E||(k="/index"===(k=b)?"/":k);let P=!0===H.isDev||!O,T=O&&!P,I=e.method||"GET",M=(0,d.getTracer)(),S=M.getActiveScopeSpan(),q={params:C,prerenderManifest:A,renderOpts:{experimental:{cacheComponents:!!v.experimental.cacheComponents,authInterrupts:!!v.experimental.authInterrupts},supportsDynamicResponse:P,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(y=v.experimental)?void 0:y.cacheLife,isRevalidate:T,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>H.onRequestError(e,t,n,x)},sharedContext:{buildId:R}},U=new l.NodeNextRequest(e),j=new l.NodeNextResponse(t),F=r.NextRequestAdapter.fromNodeNextRequest(U,(0,r.signalFromNodeResponse)(t));try{let i=async a=>H.handle(F,q).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=M.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==s.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=n.get("next.route");if(o){let e=`${I} ${o}`;a.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),a.updateName(e)}else a.updateName(`${I} ${e.url}`)}),l=async d=>{var l,r;let s=async({previousCacheEntry:a})=>{try{if(!(0,o.getRequestMeta)(e,"minimalMode")&&D&&$&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let l=await i(d);e.fetchMetrics=q.renderOpts.fetchMetrics;let r=q.renderOpts.pendingWaitUntil;r&&n.waitUntil&&(n.waitUntil(r),r=void 0);let s=q.renderOpts.collectedTags;if(!O)return await (0,c.sendResponse)(U,j,l,q.renderOpts.pendingWaitUntil),null;{let e=await l.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(l.headers);s&&(t[f.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,n=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:l.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await H.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:T,isOnDemandRevalidate:D})},x),t}},h=await H.handleResponse({req:e,nextConfig:v,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:$,responseGenerator:s,waitUntil:n.waitUntil});if(!O)return null;if((null==h||null==(l=h.value)?void 0:l.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(r=h.value)?void 0:r.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,o.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",D?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,o.getRequestMeta)(e,"minimalMode")&&O||y.delete(f.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,_.getCacheControlHeader)(h.cacheControl)),await (0,c.sendResponse)(U,j,new Response(h.value.body,{headers:y,status:h.value.status||200})),null};S?await l(S):await M.withPropagatedContext(e.headers,()=>M.trace(s.BaseServerSpan.handleRequest,{spanName:`${I} ${e.url}`,kind:d.SpanKind.SERVER,attributes:{"http.method":I,"http.target":e.url}},l))}catch(t){if(S||t instanceof h.NoFallbackError||await H.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:T,isOnDemandRevalidate:D})}),O)throw t;return await (0,c.sendResponse)(U,j,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_9a3d8863.js.map